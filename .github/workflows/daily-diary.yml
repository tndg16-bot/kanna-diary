name: Kanna's Daily Diary Generation

on:
  # Cronå®Ÿè¡Œï¼šæ¯æ—¥æ—¥æœ¬æ™‚é–“23æ™‚ï¼ˆUTC 14æ™‚ï¼‰
  schedule:
    - cron: '0 14 * * *'
  # æ‰‹å‹•å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³
  workflow_dispatch:
    inputs:
      date:
        description: 'æ—¥ä»˜ (YYYY-MM-DDå½¢å¼ã€æŒ‡å®šãªå ´åˆã¯å‰æ—¥)'
        required: false
        type: string
      backfill:
        description: 'ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼ˆ7æ—¥é–“ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ï¼‰'
        required: false
        default: 'false'
        type: string

jobs:
  generate-diary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate diary
        run: |
          # å¼•æ•°ã®æ§‹ç¯‰
          DATE_ARG=""
          if [[ "${{ inputs.date }}" != "" ]]; then
            DATE_ARG="--date ${{ inputs.date }}"
          fi
          
          if [[ "${{ inputs.backfill }}" == "true" ]]; then
            BACKFILL="--backfill"
          fi
          
          # æ—¥è¨˜ç”Ÿæˆã®å®Ÿè¡Œ
          echo "=========================================="
          echo "ã‹ã‚“ãªã®è‡ªå¾‹æ—¥è¨˜ã‚·ã‚¹ãƒ†ãƒ "
          echo "=========================================="
          echo ""
          echo "ğŸ“… æ—¥ä»˜: ${{ inputs.date }}"
          echo "ğŸ”„ ãƒ¢ãƒ¼ãƒ‰: $([[ "${{ inputs.backfill }}" == "true" ]] && echo "ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«" || echo "é€šå¸¸")"
          echo ""
          echo "----------------------------------------"
          echo ""
          
          if [[ "$DATE_ARG" != "" ]]; then
            npm run generate-diary $DATE_ARG $BACKFILL
          elif [[ "${{ inputs.backfill }}" == "true" ]]; then
            # ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼š7æ—¥é–“ã‚’ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«
            for i in {1..7}; do
              BACKFILL_DATE=$(date -d "$i days ago" +"%Y-%m-%d")
              echo "ğŸ”„ $BACKFILL_DATE ã®æ—¥è¨˜ã‚’ç”Ÿæˆä¸­..."
              npm run generate-diary --date "$BACKFILL_DATE"
              echo "   å®Œäº†"
            done
          else
            # é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šå‰æ—¥ã®æ—¥è¨˜ã‚’ç”Ÿæˆ
            npm run generate-diary
          fi
          
          echo ""
          echo "----------------------------------------"
          echo ""
          echo "âœ… æ—¥è¨˜ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          
      - name: Commit and push diary files
        run: |
          git config user.name "Kanna Diary Bot"
          git config user.email "kanna-diary-bot@tndg16-bot.github.com"
          
          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if [[ -n $(git status --porcelain) ]]; then
            git add diaries/
            git commit -m "ğŸ“” æ—¥è¨˜ç”Ÿæˆ: ${{ inputs.date }}"
            
            # GitHubã«ãƒ—ãƒƒã‚·ãƒ¥
            git push origin main
            echo "âœ… æ—¥è¨˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸ æ—¥è¨˜ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
      
      - name: Create summary
        run: |
          echo "## ğŸ“” ã‹ã‚“ãªã®æ—¥è¨˜ç”Ÿæˆ"
          echo ""
          echo "### ç”Ÿæˆçµæœ"
          echo "- æ—¥ä»˜: ${{ inputs.date }}"
          echo "- ãƒ¢ãƒ¼ãƒ‰: $([[ "${{ inputs.backfill }}" == "true" ]] && echo "ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«" || echo "é€šå¸¸")"
          echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œäº†"
      
      - name: Report failure
        if: failure()
        run: |
          echo "âŒ æ—¥è¨˜ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
