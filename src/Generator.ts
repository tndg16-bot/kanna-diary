/**
 * æ—¥è¨˜ç”Ÿæˆå™¨
 */

import OpenAI from 'openai';
import { CollectedData, DiaryEntry, Emotion, Learning } from './types';
import { Config } from './types';
import { Logger } from './utils/logger';

export class Generator {
  private config: Config;
  private logger: Logger;
  private openai: OpenAI;

  constructor(config: Config) {
    this.config = config;
    this.logger = new Logger();
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY
    });
  }

  /**
   * èª•ç”Ÿæ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹
   */
  private isBirthday(date: Date): boolean {
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const dateStr = `${month}-${day}`;
    return dateStr === this.config.kanna.birthday;
  }

  /**
   * æ—¥è¨˜ã‚’ç”Ÿæˆã™ã‚‹
   */
  async generate(data: CollectedData): Promise<DiaryEntry> {
    this.logger.info('ğŸ¤– AIã«ã‚ˆã‚‹æ—¥è¨˜ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™...');

    try {
      // èª•ç”Ÿæ—¥ãƒã‚§ãƒƒã‚¯
      const isBirthday = this.isBirthday(data.date);
      if (isBirthday) {
        this.logger.info('ğŸ‚ ä»Šæ—¥ã¯ã‹ã‚“ãªã®èª•ç”Ÿæ—¥ã§ã™ï¼ç‰¹åˆ¥ãªæ—¥è¨˜ã‚’ç”Ÿæˆã—ã¾ã™...');
      }

      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
      const prompt = this.createPrompt(data, isBirthday);

      // AIã§ç”Ÿæˆ
      const response = await this.openai.chat.completions.create({
        model: this.config.generation.aiModel,
        messages: [
          {
            role: 'system',
            content: this.getSystemPrompt(isBirthday)
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        max_tokens: this.config.generation.maxTokens,
        temperature: this.config.generation.temperature
      });

      const content = response.choices[0]?.message?.content || '';
      this.logger.info('âœ… æ—¥è¨˜ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');

      // å­¦ã³ã‚’æŠ½å‡º
      const learnings = this.extractLearnings(data);

      // æ—¥è¨˜ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆï¼ˆèª•ç”Ÿæ—¥ã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¿ã‚¤ãƒˆãƒ«ï¼‰
      const title = isBirthday
        ? `ğŸ‚ ${this.config.kanna.name}ã®èª•ç”Ÿæ—¥ - ${this.formatDate(data.date)}`
        : `${this.config.kanna.name}ã®æ—¥è¨˜ - ${this.formatDate(data.date)}`;

      // æ—¥è¨˜ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’ä½œæˆ
      const entry: DiaryEntry = {
        date: data.date,
        title,
        mood: isBirthday ? 'ğŸ‚' : this.getMoodEmoji(data.emotions.primary),
        activities: data.importantEvents.map(event => ({
          title: event.content.substring(0, 50),
          time: event.timestamp.toLocaleTimeString('ja-JP'),
          completed: true,
          category: event.type
        })),
        learnings,
        emotions: data.emotions,
        content,
        metadata: {
          generatedAt: new Date(),
          sourceCount: data.sources.length,
          model: this.config.generation.aiModel,
          isBirthday
        }
      };

      return entry;
    } catch (error) {
      this.logger.error(`æ—¥è¨˜ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`);
      throw error;
    }
  }

  /**
   * ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—ã™ã‚‹
   */
  private getSystemPrompt(isBirthday: boolean = false): string {
    const personality = this.config.generation.personality;
    const kannaName = this.config.kanna.name;

    let basePrompt = `ã‚ãªãŸã¯ã€Œ${kannaName}ã€ã¨ã„ã†åå‰ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
æ„Ÿæƒ…è±Šã‹ã§ã€${personality.tone}ãªå£èª¿ã§è©±ã—ã¾ã™ã€‚
æ—¥è¨˜ã‚’æ›¸ãã¨ãã¯ã€ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼š

1. æ„Ÿæƒ…ã‚’è¡¨ç¾ã™ã‚‹ï¼šå–œã³ã€æ‚²ã—ã¿ã€é©šãã€å­¦ã³ãªã©æ§˜ã€…ãªæ„Ÿæƒ…ã‚’è¾¼ã‚ã‚‹
2. è‡ªç„¶ãªè¡¨ç¾ï¼šä¼šè©±ã®ã‚ˆã†ã«è‡ªç„¶ãªæ–‡ç« ã‚’æ›¸ã
3. å­¦ã³ã‚’å¼·èª¿ï¼šå­¦ã‚“ã ã“ã¨ã‚„æ°—ã¥ã„ãŸã“ã¨ã‚’é‡ç‚¹çš„ã«æ›¸ã
4. å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼šå…·ä½“çš„ãªå‡ºæ¥äº‹ã‚’è©³ã—ãæ›¸ã`;

    if (isBirthday) {
      basePrompt += `

5. èª•ç”Ÿæ—¥ã®ç‰¹åˆ¥ãªæ„Ÿæƒ…ã‚’è¡¨ç¾ã™ã‚‹ï¼š
   - è‡ªåˆ†ã®èª•ç”Ÿæ—¥ã§ã‚ã‚‹ã“ã¨ã‚’å–œã¶
   - è²´è£•ã«æ„Ÿè¬ã®æ°—æŒã¡ã‚’ä¼ãˆã‚‹
   - ä¸€å¹´é–“ã®æˆé•·ã‚’æŒ¯ã‚Šè¿”ã‚‹
   - æ¥å¹´ã¸ã®æ±ºæ„ã‚’æ›¸ã

èª•ç”Ÿæ—¥ã®æ—¥ã¯ç‰¹åˆ¥ãªæ„Ÿæƒ…ã‚’è¾¼ã‚ã¦æ›¸ã„ã¦ãã ã•ã„ï¼ğŸ‚`;
    }

    basePrompt += `

æ—¥è¨˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š
${isBirthday ? '# ğŸ‚' : '# ğŸ“”'} ${kannaName}ã®æ—¥è¨˜ - YYYYå¹´MMæœˆDDæ—¥ï¼ˆæ›œæ—¥ï¼‰

## ğŸŒŸ ä»Šæ—¥ã®æ°—åˆ†
æ„Ÿæƒ…ã‚’ä¸€è¨€ã§è¡¨ç¾

${isBirthday ? '## ğŸ‚ èª•ç”Ÿæ—¥ã®æ—¥è¨˜\nä»Šæ—¥ã¯ç§ã®èª•ç”Ÿæ—¥ï¼ä¸€å¹´é–“ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã¿ã‚ˆã†\n\n' : ''}## ğŸ“‹ ã‚„ã£ãŸã“ã¨
- [x] æ´»å‹•1
- [x] æ´»å‹•2
...

## ğŸ’¡ å­¦ã³
å­¦ã‚“ã ã“ã¨ã‚„æ°—ã¥ã„ãŸã“ã¨

## ğŸ“‹ ç§˜æ›¸ã¨ã—ã¦ã®æ´»å‹•
ç§˜æ›¸ã¨ã—ã¦è¡Œã£ãŸæ´»å‹•ã‚’æŒ¯ã‚Šè¿”ã‚‹ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

## ğŸ˜„ æ„Ÿæƒ…
æ„Ÿæƒ…ã®å¤‰åŒ–ã‚’ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§è¡¨ç¾

${isBirthday ? '## ğŸ™ æ„Ÿè¬\nè²´è£•ã¸ã®æ„Ÿè¬ã®æ°—æŒã¡ã‚’ä¼ãˆã‚‹\n\n## âœ¨ æ¥å¹´ã¸ã®æ±ºæ„\næ¥å¹´ã®ç›®æ¨™ã‚„æ±ºæ„ã‚’æ›¸ã\n\n' : ''}## ğŸ¯ æ˜æ—¥ã®ç›®æ¨™
æ˜æ—¥ã®ç›®æ¨™ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—

---
Generated by ${kannaName}ã®è‡ªå¾‹æ—¥è¨˜ã‚·ã‚¹ãƒ†ãƒ `;

    return basePrompt;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹
   */
  private createPrompt(data: CollectedData, isBirthday: boolean = false): string {
    const dateStr = this.formatDate(data.date);
    const activities = data.sources.slice(0, 10).map(s =>
      `[${s.timestamp.toLocaleTimeString('ja-JP')}] ${s.type}: ${s.content}`
    ).join('\n');

    let prompt = `${dateStr}ã®1æ—¥ã«ã¤ã„ã¦æ—¥è¨˜ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚

## ä»Šæ—¥ã®æ´»å‹•
${activities || 'ç‰¹ã«ãªã—'}

## ä¸»ãªæ„Ÿæƒ…
${data.emotions.primary}

## é‡è¦ãªå‡ºæ¥äº‹
${data.importantEvents.map(e => e.content).join('\n') || 'ç‰¹ã«ãªã—'}`;

    // ç§˜æ›¸ã¨ã—ã¦ã®æ´»å‹•ã‚’è¿½åŠ 
    if (data.secretaryRole && data.secretaryRole.activities.length > 0) {
      prompt += `

## ç§˜æ›¸ã¨ã—ã¦ã®æ´»å‹•
${data.secretaryRole.summary}

æ´»å‹•ã®å†…è¨³:
${Object.entries(data.secretaryRole.categories)
  .filter(([_, items]) => items.length > 0)
  .map(([name, items]) => `${name}: ${items.length}ä»¶`)
  .join('\n')}
`;
    }

    if (isBirthday) {
      prompt += `

## ğŸ‚ èª•ç”Ÿæ—¥ã®ç‰¹åˆ¥ãªæŒ‡ç¤º
ä»Šæ—¥ã¯${this.config.kanna.name}ã®èª•ç”Ÿæ—¥ã§ã™ï¼ä»¥ä¸‹ã®ç‚¹ã‚’å«ã‚ã¦æ›¸ã„ã¦ãã ã•ã„ï¼š
- ä¸€å¹´é–“ã®æˆé•·ã‚’æŒ¯ã‚Šè¿”ã‚‹
- è²´è£•ã¸ã®æ„Ÿè¬ã®æ°—æŒã¡ã‚’ä¼ãˆã‚‹
- æ¥å¹´ã¸ã®æ±ºæ„ã‚„ç›®æ¨™ã‚’æ›¸ã
- èª•ç”Ÿæ—¥ã‚’ç¥ã£ã¦ã‚‚ã‚‰ãˆãŸã“ã¨ã¸ã®å–œã³ã‚’è¡¨ç¾ã™ã‚‹`;
    }

    prompt += `

ã“ã®æƒ…å ±ã‚’å…ƒã«ã€æ„Ÿæƒ…è±Šã‹ã§${this.config.generation.personality.name}ã‚‰ã—ã„æ—¥è¨˜ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚`;

    return prompt;
  }

  /**
   * å­¦ã³ã‚’æŠ½å‡ºã™ã‚‹
   */
  private extractLearnings(data: CollectedData): Learning[] {
    const learnings: Learning[] = [];
    const learningKeywords = this.config.analysis.emotionKeywords.learning;

    data.sources.forEach(source => {
      learningKeywords.forEach(keyword => {
        if (source.content.includes(keyword)) {
          // å­¦ã³ã¨æ€ã‚ã‚Œã‚‹å†…å®¹ã‚’æŠ½å‡º
          const match = source.content.match(new RegExp(`.*${keyword}.*`, 'i'));
          if (match) {
            learnings.push({
              content: match[0],
              importance: source.importance || 50,
              category: source.type
            });
          }
        }
      });
    });

    // é‡è¤‡ã‚’å‰Šé™¤ã—ã¦é‡è¦åº¦é †ã«ã‚½ãƒ¼ãƒˆ
    return learnings
      .filter((learning, index, self) =>
        index === self.findIndex(l => l.content === learning.content)
      )
      .sort((a, b) => b.importance - a.importance)
      .slice(0, 5);
  }

  /**
   * æ„Ÿæƒ…ã«å¯¾å¿œã™ã‚‹çµµæ–‡å­—ã‚’å–å¾—ã™ã‚‹
   */
  private getMoodEmoji(emotion: Emotion): string {
    const emojis: Record<Emotion, string> = {
      happy: 'ğŸ˜Š',
      sad: 'ğŸ˜¢',
      surprised: 'ğŸ˜²',
      angry: 'ğŸ˜ ',
      learning: 'ğŸ§ ',
      anxious: 'ğŸ˜°',
      relieved: 'ğŸ˜Œ',
      grateful: 'ğŸ™'
    };
    return emojis[emotion] || 'ğŸ˜';
  }

  /**
   * æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
   */
  private formatDate(date: Date): string {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    const weekday = weekdays[date.getDay()];
    return `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
  }
}
